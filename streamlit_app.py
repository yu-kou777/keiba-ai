import streamlit as st
import pandas as pd
import re

st.set_page_config(page_title="AIç«¶é¦¬ï¼šãã¡ã‚ƒãã¡ã‚ƒè§£æ¶ˆç‰ˆ", layout="centered")

st.title("ğŸ‡ AIç«¶é¦¬ï¼šã‚³ãƒ”ãƒšå…¨è‡ªå‹•è§£æ")
st.write("ã‚µã‚¤ãƒˆã‚’å…¨é¸æŠã‚³ãƒ”ãƒ¼ã—ã¦ã€ä¸‹ã®æ ã«ã€ãƒšãƒ¼ã‚¹ãƒˆã€ã™ã‚‹ã ã‘ã§OKã§ã™ã€‚")

# --- å†…éƒ¨ãƒ­ã‚¸ãƒƒã‚¯ï¼šã‚¨ã‚¯ã‚»ãƒ«ãªã—ã§ã‚‚å‹•ãã€Œç¨®ç‰¡é¦¬è©•ä¾¡ã€ ---
# 2026å¹´æœ€æ–°ã®æœ‰åŠ›ç¨®ç‰¡é¦¬ãƒªã‚¹ãƒˆï¼ˆã“ã“ã«è¼‰ã£ã¦ã„ã‚Œã°åŠ ç‚¹ï¼‰
TOP_SIRES = ["ã‚­ã‚ºãƒŠ", "ã‚¨ãƒ”ãƒ•ã‚¡ãƒã‚¤ã‚¢", "ãƒ­ãƒ¼ãƒ‰ã‚«ãƒŠãƒ­ã‚¢", "ãƒ‰ã‚¥ãƒ©ãƒ¡ãƒ³ãƒ†", "ã‚·ãƒ‹ã‚¹ã‚¿ãƒ¼ãƒŸãƒ‹ã‚¹ã‚¿", 
             "ãƒ¢ãƒ¼ãƒªã‚¹", "ãƒãƒ¼ãƒ„ã‚¯ãƒ©ã‚¤", "ãƒ«ãƒ¼ãƒ©ãƒ¼ã‚·ãƒƒãƒ—", "ãƒ˜ãƒ‹ãƒ¼ãƒ’ãƒ¥ãƒ¼ã‚º", "ãƒ›ãƒƒã‚³ãƒ¼ã‚¿ãƒ«ãƒã‚¨"]

def parse_messy_text(text):
    """
    ãã¡ã‚ƒãã¡ã‚ƒãªãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰ã€é¦¬åãƒ»çˆ¶åãƒ»ã‚ªãƒƒã‚ºã‚’å¸ã„å‡ºã™
    """
    # 1. ã¾ãšã‚«ã‚¿ã‚«ãƒŠï¼ˆé¦¬åãƒ»çˆ¶åï¼‰ã‚’ã™ã¹ã¦æŠœãå‡ºã™
    all_katakana = re.findall(r'[ã‚¡-ãƒ¶ãƒ¼]{2,9}', text)
    # 2. æ•°å­—ï¼ˆã‚ªãƒƒã‚ºï¼šä¾‹ 5.5ï¼‰ã‚’ã™ã¹ã¦æŠœãå‡ºã™
    all_odds = re.findall(r'\d{1,3}\.\d', text)
    
    # 3. é™¤å¤–ãƒ¯ãƒ¼ãƒ‰ï¼ˆç«¶é¦¬ã‚µã‚¤ãƒˆã«ã‚ˆãã‚ã‚‹ã€Œã‚¿ã‚¤ãƒ ã€ã‚„ã€Œã‚ªãƒƒã‚ºã€ã¨ã„ã†æ–‡å­—ã‚’æ¶ˆã™ï¼‰
    ignore = ["ã‚ªãƒƒã‚º", "ã‚¿ã‚¤ãƒ ", "ãƒšãƒ¼ã‚¹", "ã‚°ãƒ¬ãƒ¼ãƒ‰", "ãƒ€ãƒ¼ãƒˆ", "ã‚³ãƒ¼ã‚¹", "ã‚¦ã‚§ãƒ–", "æ–°è"]
    names = [n for n in all_katakana if n not in ignore]
    
    # 4. é¦¬åã¨ã‚ªãƒƒã‚ºã‚’ãƒšã‚¢ã«ã™ã‚‹
    # ç«¶é¦¬ã‚µã‚¤ãƒˆã¯ã€Œé¦¬åã€ã®ã‚ã¨ã«ã€Œçˆ¶åã€ã€ãã®å°‘ã—å¾Œã«ã€Œã‚ªãƒƒã‚ºã€ãŒæ¥ã‚‹
    data = []
    # é‡è¤‡ã‚’é¿ã‘ã¦18é ­åˆ†ä½œã‚‹
    unique_names = []
    for n in names:
        if n not in unique_names: unique_names.append(n)
        if len(unique_names) >= 40: break # å¤šã‚ã«å–ã£ã¦ãŠã

    # ã‚ªãƒƒã‚ºã¨åå‰ã‚’é †ç•ªã«çµåˆï¼ˆã“ã‚ŒãŒä¸€ç•ªã‚ºãƒ¬ã«ãã„ï¼‰
    for i in range(min(len(unique_names)//2, len(all_odds))):
        horse_name = unique_names[i*2] # 1ã¤ãŠãã«é¦¬åã¨ä»®å®š
        sire_name = unique_names[i*2 + 1] # ãã®æ¬¡ã‚’çˆ¶åã¨ä»®å®š
        val_odds = float(all_odds[i])
        
        if val_odds > 1.0:
            data.append({"é¦¬å": horse_name, "çˆ¶": sire_name, "ã‚ªãƒƒã‚º": val_odds})
            if len(data) >= 18: break

    return pd.DataFrame(data)

# --- UI ---
st.info("ğŸ’¡ ç«¶é¦¬ãƒ©ãƒœã®ã€ç°¡æ˜“å‡ºé¦¬è¡¨ã€ã‚’å…¨é¸æŠã‚³ãƒ”ãƒ¼ã—ã¦ã€ä¸‹ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚")
raw_input = st.text_area("ã“ã“ã«ãƒšãƒ¼ã‚¹ãƒˆ", height=300)

if st.button("AIè§£æãƒ»äºˆæƒ³ã‚¹ã‚¿ãƒ¼ãƒˆ"):
    if raw_input:
        df = parse_messy_text(raw_input)
        
        if not df.empty:
            # --- AIã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ï¼ˆæœŸå¾…å€¤ãƒ­ã‚¸ãƒƒã‚¯ï¼‰ ---
            def scoring(row):
                score = 50
                if any(s in row['çˆ¶'] for s in TOP_SIRES): score += 20 # è¡€çµ±åŠ ç‚¹
                return score

            df["AIã‚¹ã‚³ã‚¢"] = df.apply(scoring, axis=1)
            # æœŸå¾…å€¤ = (ã‚¹ã‚³ã‚¢/åŸºæº–) / ã‚ªãƒƒã‚º
            df["æœŸå¾…å€¤"] = (df["AIã‚¹ã‚³ã‚¢"] / 50) * (15 / df["ã‚ªãƒƒã‚º"])
            
            st.success(f"è§£ææˆåŠŸï¼š{len(df)}é ­ã‚’æ¤œå‡º")
            res_df = df.sort_values("æœŸå¾…å€¤", ascending=False)
            
            st.subheader("ğŸ“Š æœŸå¾…å€¤ãƒ©ãƒ³ã‚­ãƒ³ã‚°")
            st.table(res_df[['é¦¬å', 'çˆ¶', 'ã‚ªãƒƒã‚º', 'æœŸå¾…å€¤']].head(10))
            
            st.divider()
            st.subheader("ğŸ¯ æ¨å¥¨è²·ã„ç›®")
            top_3 = res_df.head(3)["é¦¬å"].tolist()
            st.warning(f"â— {top_3[0]}  /  â—‹ {top_3[1]}  /  â–² {top_3[2]}")
        else:
            st.error("ã†ã¾ãèª­ã¿å–ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚ã‚³ãƒ”ãƒ¼ã™ã‚‹ç¯„å›²ã‚’åºƒã’ã¦ã¿ã¦ãã ã•ã„ã€‚")
    else:
        st.warning("ãƒ‡ãƒ¼ã‚¿ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚")
