import streamlit as st
import pandas as pd
import re

st.set_page_config(page_title="AIç«¶é¦¬ï¼šé«˜ç²¾åº¦ãƒ»å®Œå…¨ç‰ˆ", layout="centered")

st.title("ğŸ‡ AIç«¶é¦¬ï¼šé«˜ç²¾åº¦è§£æäºˆæƒ³")
st.write("ç«¶é¦¬ãƒ©ãƒœã®ã€ç°¡æ˜“å‡ºé¦¬è¡¨ã€ã‚’å…¨é¸æŠã‚³ãƒ”ãƒ¼ã—ã¦è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚")

# --- å†…éƒ¨ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼šæœ€æ–°æœ‰åŠ›è¡€çµ± (ã‚¨ã‚¯ã‚»ãƒ«ã®ç¨®ç‰¡é¦¬50/BMS50ç›¸å½“) ---
TOP_SIRES = ["ãƒ‰ã‚¥ãƒ©ãƒ¡ãƒ³ãƒ†", "ãƒ­ãƒ¼ãƒ‰ã‚«ãƒŠãƒ­ã‚¢", "ãƒ‡ã‚£ãƒ¼ãƒ—ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆ", "ã‚­ã‚ºãƒŠ", "ã‚¨ãƒ”ãƒ•ã‚¡ãƒã‚¤ã‚¢", "ãƒãƒ¼ãƒ„ã‚¯ãƒ©ã‚¤", "ãƒ¢ãƒ¼ãƒªã‚¹"]
TOP_BMS = ["ãƒ‡ã‚£ãƒ¼ãƒ—ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆ", "ã‚­ãƒ³ã‚°ã‚«ãƒ¡ãƒãƒ¡ãƒ", "ãƒãƒ³ãƒãƒƒã‚¿ãƒ³ã‚«ãƒ•ã‚§", "ã‚·ãƒ³ãƒœãƒªã‚¯ãƒªã‚¹ã‚¨ã‚¹"]

def smart_parse(text):
    """
    ãã¡ã‚ƒãã¡ã‚ƒãªãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰ã€Œé¦¬ç•ªãƒ»é¦¬åãƒ»çˆ¶ãƒ»ã‚ªãƒƒã‚ºã€ã‚’æ­£ç¢ºã«ã‚»ãƒƒãƒˆã§æŠœãå‡ºã™
    """
    # 1. ãƒ†ã‚­ã‚¹ãƒˆã‚’è¡Œã”ã¨ã«åˆ†å‰²ã—ã€ä½™è¨ˆãªç©ºç™½ã‚’æ¶ˆã™
    lines = [line.strip() for line in text.split('\n') if line.strip()]
    
    extracted = []
    
    # 2. ã€Œé¦¬ç•ªã€ã‚’èµ·ç‚¹ã«ãƒ‡ãƒ¼ã‚¿ã‚’ã‚»ãƒƒãƒˆåŒ–ã™ã‚‹
    # ç«¶é¦¬ãƒ©ãƒœç­‰ã®æ§‹é€ : æ , é¦¬, å°, é¦¬å, æŒ‡æ•°, è¡€çµ±(çˆ¶)... æ–¤é‡, é¨æ‰‹, å˜å‹(ã‚ªãƒƒã‚º)
    for i in range(len(lines)):
        # è¡ŒãŒã€Œé¦¬ç•ª(1-18)ã€ã§å§‹ã¾ã£ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        # ä¾‹: "11 ãƒŸãƒƒã‚­ãƒ¼ã‚¯ãƒ¬ã‚¹ãƒˆ" ã¾ãŸã¯ "11 \n ãƒŸãƒƒã‚­ãƒ¼ã‚¯ãƒ¬ã‚¹ãƒˆ"
        match = re.match(r'^(\d{1,2})$', lines[i])
        if match:
            try:
                baban = match.group(1)
                # é¦¬åã¯é¦¬ç•ªã®ã™ãå¾Œã‹ã€æ•°è¡Œå…ˆã«ã‚ã‚‹
                name = ""
                sire = ""
                odds = 0.0
                
                # æ¬¡ã®15è¡Œä»¥å†…ã‹ã‚‰å¿…è¦ãªæƒ…å ±ã‚’æ¢ã™
                for j in range(i + 1, min(i + 15, len(lines))):
                    # é¦¬åã®æŠ½å‡º (2-9æ–‡å­—ã®ã‚«ã‚¿ã‚«ãƒŠ)
                    if not name and re.match(r'^[ã‚¡-ãƒ¶ãƒ¼]{2,9}$', lines[j]):
                        name = lines[j]
                        continue
                    # çˆ¶é¦¬ã®æŠ½å‡º (é¦¬åãŒæ±ºã¾ã£ãŸå¾Œã«æœ€åˆã«å‡ºã¦ãã‚‹ã‚«ã‚¿ã‚«ãƒŠ)
                    if name and not sire and re.match(r'^[ã‚¡-ãƒ¶ãƒ¼]{2,10}$', lines[j]) and lines[j] != name:
                        sire = lines[j]
                        continue
                    # ã‚ªãƒƒã‚ºã®æŠ½å‡º (x.x ã®å½¢å¼)
                    odds_match = re.match(r'^(\d{1,3}\.\d)$', lines[j])
                    if odds_match:
                        odds = float(odds_match.group(1))
                        break
                
                if name and odds > 0:
                    extracted.append({"é¦¬ç•ª": baban, "é¦¬å": name, "çˆ¶": sire, "ã‚ªãƒƒã‚º": odds})
            except:
                continue

    return pd.DataFrame(extracted).drop_duplicates(subset=['é¦¬ç•ª'])

# --- UI ---
st.info("ğŸ’¡ ç«¶é¦¬ãƒ©ãƒœã®ã€ç°¡æ˜“å‡ºé¦¬è¡¨ã€ãƒšãƒ¼ã‚¸ã‚’å…¨é¸æŠï¼ˆé•·æŠ¼ã—â†’ã™ã¹ã¦é¸æŠï¼‰ã—ã¦ã‚³ãƒ”ãƒ¼ã—ã€ä¸‹ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚")
raw_input = st.text_area("ã‚³ãƒ”ãƒšã‚¨ãƒªã‚¢", height=300, placeholder="ã“ã“ã«ãƒšãƒ¼ã‚¹ãƒˆ...")

if st.button("AIäºˆæƒ³ã‚’å®Ÿè¡Œ"):
    if raw_input:
        df = smart_parse(raw_input)
        
        if not df.empty:
            # --- æœ€æ–°ãƒ­ã‚¸ãƒƒã‚¯é©ç”¨ (ã‚¨ã‚¯ã‚»ãƒ«ä¸è¦) ---
            def calculate_ai_score(row):
                score = 50 # åŸºæº–
                # è¡€çµ±åŠ ç‚¹ (çˆ¶ãŒãƒ©ãƒ³ã‚­ãƒ³ã‚°ä¸Šä½ãªã‚‰+20)
                if any(s in str(row['çˆ¶']) for s in TOP_SIRES): score += 20
                # BMSåŠ ç‚¹ (ç°¡æ˜“çš„ã«çˆ¶åã«BMSæœ‰åŠ›é¦¬ãŒã„ã‚Œã°+10)
                if any(b in str(row['çˆ¶']) for b in TOP_BMS): score += 10
                return score

            df["AIã‚¹ã‚³ã‚¢"] = df.apply(calculate_ai_score, axis=1)
            # æœŸå¾…å€¤ = (AIã‚¹ã‚³ã‚¢/50) * (15/ã‚ªãƒƒã‚º)
            df["æœŸå¾…å€¤"] = (df["AIã‚¹ã‚³ã‚¢"] / 50) * (15 / df["ã‚ªãƒƒã‚º"])
            
            st.success(f"{len(df)}é ­ã‚’æ­£ç¢ºã«èªè­˜ã—ã¾ã—ãŸï¼")
            res_df = df.sort_values("æœŸå¾…å€¤", ascending=False)
            
            # çµæœã®è¡¨ç¤º
            st.subheader("ğŸ“Š æœŸå¾…å€¤ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆå›åç‡é‡è¦–ï¼‰")
            st.table(res_df[['é¦¬ç•ª', 'é¦¬å', 'çˆ¶', 'ã‚ªãƒƒã‚º', 'æœŸå¾…å€¤']].head(10))
            
            # è²·ã„ç›®ææ¡ˆ
            st.divider()
            st.subheader("ğŸ¯ æ¨å¥¨è²·ã„ç›®")
            top_3 = res_df.head(3)
            st.write(f"**â— è»¸é¦¬:** {top_3.iloc[0]['é¦¬å']} ({top_3.iloc[0]['é¦¬ç•ª']})")
            st.write(f"**ç›¸æ‰‹:** {', '.join(top_3['é¦¬å'].tolist()[1:])}")
            st.info("ğŸ’¡ é¦¬é€£ãƒ»ãƒ¯ã‚¤ãƒ‰BOXã€ã¾ãŸã¯3é€£å˜ã®1é ­è»¸ãƒãƒ«ãƒãŒæ¨å¥¨ã§ã™ã€‚")
        else:
            st.error("é¦¬ã®ãƒ‡ãƒ¼ã‚¿ã‚’ç‰¹å®šã§ãã¾ã›ã‚“ã§ã—ãŸã€‚")
            st.info("ã€è§£æ±ºç­–ã€‘ç«¶é¦¬ãƒ©ãƒœã®ã€ç°¡æ˜“å‡ºé¦¬è¡¨ã€ã®ãƒšãƒ¼ã‚¸ã§ã€é¦¬ã®åå‰ãŒè¼‰ã£ã¦ã„ã‚‹è¡¨ã®éƒ¨åˆ†ã‚’ã—ã£ã‹ã‚Šã‚³ãƒ”ãƒ¼ã—ã¦ã‹ã‚‰è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚")
    else:
        st.warning("ãƒ‡ãƒ¼ã‚¿ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚")
